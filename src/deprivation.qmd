---
title: "Using a Bayesian Framework for Analysing the Effect of Deprivation on Health Outcomes"
author: "Paul Johnson"
format: 
  html:
    toc: true
editor_options: 
  chunk_output_type: console
---
```{r setup}
#| include: false

library(dplyr)
library(ggplot2)
library(rstanarm)

theme_set(theme_minimal(base_family = "sans"))
bayesplot::color_scheme_set("teal")

deprivation_df <- 
  readr::read_rds(here::here("data", "deprivation.rds"))
```


## Frequentist Vs Bayesian Statistics: A Primer



## Visual Exploration of Deprivation and Health Inequalities Data


```{r}

deprivation_df %>%
  ggplot(aes(life_expectancy, imd_score)) +
  geom_point()

```

```{r}

deprivation_df %>%
  ggplot(aes(life_expectancy, physiological_risk_factors)) +
  geom_point()

deprivation_df %>%
  ggplot(aes(life_expectancy, behavioural_risk_factors)) +
  geom_point()

```

## Linear Regression the Frequentist Way

```{r life-expectancy-ols}

life_expectancy_ols <-
  lm(life_expectancy ~ imd_score + physiological_risk_factors + behavioural_risk_factors,
    data = deprivation_df
    )

summary(life_expectancy_ols)

```

## Bayesian Regression

```{r}

mean_imd <- mean(deprivation_df$imd_score)

deprivation_df <-
  deprivation_df %>%
  mutate(
    imd_transformed = imd_score - mean_imd,
    physiological_transformed = physiological_risk_factors - 100,
    behavioural_transformed = behavioural_risk_factors - 100
    )


```

### Constructing Sensible Priors

First we need to come up with some priors. Given everything we already know about life expectancy at birth and the effect that deprivation has on health outcomes, we should be able to constrain our prior distribution in relatively informative ways. 

First, we would expect life expectancy at birth to be around 80, with some variance, probably around 5-10 years, but we will go for 20 years so as to avoid the priors having too much control over the posterior distribution.

With IMD Deciles, we can reasonably expect that we should observe a negative relationship on health outcomes as deprivation increases, meaning that as IMD Deciles increase (meaning lower deprivation), life expectancy should increase. The effect is unlikely to be huge, so we will conservatively estimate that each one unit increase in IMD Decile will be associated with a one unit decrease in life expectancy at birth. The key here is more the standard error, which we will constraint sufficiently to mean that our prior is that deprivation will only have a negative effect on life expectancy.

```{r life-expectancy-priors}
#| echo: true
#| results: hide

life_expectancy_priors <- 
  stan_glm(
    life_expectancy ~ imd_transformed + physiological_transformed + behavioural_transformed,
    data = deprivation_df,
    prior_intercept = normal(80, 1),
    prior = normal(location = c(-1, 1, 1), scale = c(0.25, 0.25, 0.25)),
    prior_PD = TRUE
    )
```

We can see a summary of our priors here:

```{r prior-summary}
prior_summary(life_expectancy_priors)
```

The prior distributions look pretty sensible:

```{r prior-plot}
#| message: false
plot(life_expectancy_priors, "hist")

```

## Bayesian GLM

```{r}
#| echo: true
#| results: hide

life_expectancy_glm <- 
  stan_glm(
    life_expectancy ~ imd_transformed + physiological_transformed + behavioural_transformed,
    data = deprivation_df,
    prior_intercept = normal(80, 1),
    prior = normal(location = c(-1, 1, 1), scale = c(0.25, 0.25, 0.25))
    )

life_expectancy_posterior <- as.matrix(life_expectancy_glm)

```

```{r}

bayesplot::mcmc_areas(
  life_expectancy_posterior,
  pars = c(
    "imd_transformed",
    "physiological_transformed",
    "behavioural_transformed",
    "sigma"
    ),
  prob = 0.8
)

bayesplot::ppc_dens_overlay(y = life_expectancy_glm$y,
                 yrep = posterior_predict(life_expectancy_glm, draws = 50)) +
  labs(
    title = "Posterior Predictive Checks Against Observed Data",
    subtitle = "Samples Drawn from Posterior Predictive Distribution of Life Expectancy by IMD Score and Physiological & Behavioural Risk Factors",
    x = "Life Expectancy"
    ) +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 12)
  )

posterior_vs_prior(life_expectancy_glm, prob = 0.8,
                   group_by_parameter = TRUE,
                   facet_args = list(scales = "free"))

bayesplot::ppc_scatter_avg(y = life_expectancy_glm$y,
                           yrep = posterior_predict(life_expectancy_glm, draws = 50))


```
